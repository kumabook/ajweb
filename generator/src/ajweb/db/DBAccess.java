package ajweb.db;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Properties;
import java.util.Random;
import java.util.Map.Entry;

import ajweb.utils.Log;

/**
 * データベースアクセスのユーティリティクラス。
 * 同じドライバ、データベースのインスタンスは複数つくらない方が良い？（デッドロックの可能性あり）
 * 
 * @author Hiroki Kumamoto
 *
 */
public class DBAccess {
	

	String driverClassName;
	String dbName;
	Connection conn;
	
	
	
	/**
	 * デフォルトのコンストラクタ<br>
	 * データベースは組み込みのApache derbyを用いる
	 */
	public DBAccess(){
		driverClassName = "org.apache.derby.jdbc.EmbeddedDriver";
		dbName = "jdbc:derby:ajweb_derby";
	}
	/**
	 * データベースドライバー、データベース名を指定するコンストラクタ。
	 * @param driverClassName ドライバーの名前
	 * @param dbName データベース名
	 */
	public DBAccess(String driverClassName, String dbName){
		this.driverClassName = driverClassName;
		this.dbName = dbName;
	}
	
	
		
	
	/**
	 * ajwebがサポートするデータ型をデータベーススキーマ用の文字列に変換
	 * @param st
	 * @return
	 */
	public static String getType(String st){
		
		st = st.trim();
		
		if(st.equals("string")){
			return "varchar(100)";
		}
		else if(st.equals("int")){
			return "int";
		}
		else if(st.equals("datetime")){
			return "timestamp";
		}
		
		return st;
	}
	/**
	 * コネクションを取得
	 * @return
	 * @throws InstantiationException
	 * @throws IllegalAccessException
	 * @throws ClassNotFoundException
	 * @throws SQLException
	 */
	private Connection getConnection() 
		throws InstantiationException, IllegalAccessException, 
		ClassNotFoundException, SQLException{
			Class.forName(driverClassName).newInstance();

			Properties props = new Properties();
			props.put("create", "true");
			if(conn == null)
				 conn = DriverManager.getConnection(dbName,props);//ここのデータベース名は設定
			conn.setAutoCommit(false);
			
			return conn;
	}
	
	
	
	/**
	 * データベーステーブルを作成
	 * @param tableName テーブル名
	 * @param properties スキーマのプロパティのハッシュ(名前とデータ型)
	 * @throws SQLException
	 * @throws InstantiationException
	 * @throws IllegalAccessException
	 * @throws ClassNotFoundException
	 */
	public void create(String tableName, HashMap<String,String> properties) throws SQLException, InstantiationException, IllegalAccessException, ClassNotFoundException{
	
		String sql = "CREATE TABLE " + tableName + "( ";
		
		Iterator<Entry<String, String>> ite = properties.entrySet().iterator();
//		sql += "id int NOT NULL GENERATED ALWAYS AS IDENTITY primary key, ";
		sql += "id int NOT NULL primary key, ";
		while(ite.hasNext()){
			Entry<String, String> e = ite.next();
			sql += e.getKey() + " " + getType(e.getValue());
			if(ite.hasNext()) 
				sql += " ,";
		}
		sql += " )";
		
		Log.finer(sql);

		conn = getConnection();
		Statement st = conn.createStatement();
		st.execute(sql);
		st.close();
		conn.commit();
		close();
		Log.finer("new table '" + tableName + "' created.");

	}
	/**
	 * データベーステーブルの削除
	 * @param tableName テーブル名
	 * @throws InstantiationException
	 * @throws IllegalAccessException
	 * @throws ClassNotFoundException
	 * @throws SQLException
	 */
	public void drop(String tableName) throws InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException{
		String sql = "DROP TABLE " + tableName;
		Log.finer(sql);

		conn = getConnection();
		Statement st = conn.createStatement();
		Log.finer(sql);
		
		st.execute(sql);
		st.close();
		conn.commit();
		close();
		Log.finer("drop " + tableName);
		
	}
		
	
	/**
	 * INSERT文を実行
	 * @param param
	 * @throws SQLException 
	 * @throws ClassNotFoundException 
	 * @throws IllegalAccessException 
	 * @throws InstantiationException 
	 */
	
	public HashMap<String, String> insert(String tableName, HashMap<String, String> properties, HashMap<String, String> param) throws InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException {

		
		String sql = "INSERT INTO " + tableName + "(";
		String _sql = "";
		Iterator<Entry<String, String>> ite = properties.entrySet().iterator();
		while(ite.hasNext()){
			Entry<String, String> e = ite.next();
			sql += e.getKey();
//			_sql =  "'" + getType(e.getValue()) + "'";
			_sql +=  "?";
			if(ite.hasNext()){ 
				sql += ", ";
				_sql += ", ";
			}
		}
//		sql += ") values(";
		sql += ", id) values(";
		
		Random random = new Random();  
		int ran = random.nextInt(100000);//  
		
//		_sql += "  )";
		_sql += ", ?)";
		sql = sql + _sql;
		
		Log.finer(sql);
		Connection conn;
		
		conn = getConnection();

		Log.finer(sql);
		PreparedStatement st = conn.prepareStatement(sql);
		
		ite = param.entrySet().iterator();
		int index = 1;
		while(ite.hasNext()){
			Entry<String, String> e = ite.next();
//			System.out.println(index + "   " + e.getValue());
			st.setString(index, e.getValue());
			index++;
		}
		
		st.setInt(index, ran);
		
		st.execute();
		st.close();
		conn.commit();
		close();
		
		
		@SuppressWarnings("unchecked")
		HashMap<String, String>result  = (HashMap<String, String>) param.clone();
		result.put("id" , ran+"");
		return result;
			
	}	
		
	/**
	 * update文を実行(idベースに変更する必要あり)
	 * @param tableName
	 * @param properties
	 * @param param
	 * @throws InstantiationException
	 * @throws IllegalAccessException
	 * @throws ClassNotFoundException
	 * @throws SQLException
	 */
	public void update(String tableName, HashMap<String, String> properties, HashMap<String, String> param) throws InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException{
	
						
		
		String sql = "UPDATE " + tableName + " SET ";
			
		Iterator<Entry<String, String>> ite = properties.entrySet().iterator();
		while(ite.hasNext()){
			Entry<String, String> e = ite.next();
			sql += e.getKey() + "=?";
				
			if(ite.hasNext()){ 
				sql += ", ";
			}
		}
		//where節でid指定
						
		Connection conn = getConnection();
		Log.finer(sql);

		PreparedStatement st = conn.prepareStatement(sql);
			
		ite = param.entrySet().iterator();
		int index = 1;
		while(ite.hasNext()){
			Entry<String, String> e = ite.next();
			st.setString(index, e.getValue());
			index++;
		}
			
		st.execute();
		st.close();
		conn.commit();
		close();
		
		Log.finer("update " );
	}

			
		
	public  Boolean delete(String tableName, AbstractCondition where) throws InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException{
		Connection conn = getConnection();
		
		PreparedStatement st;
		Boolean rs = false;
		
		
		Log.finer("DELETE  FROM " + tableName + " WHERE " + where.toPreparedSQL());
		st = conn.prepareStatement("DELETE  FROM " + tableName + " WHERE " + where.toPreparedSQL());
		where.setPreparedSQL(st);
				
		rs = st.execute();
		
		
		st.close();
		conn.commit();
		close();
		Log.finest("delete " + tableName + " " + where.toPreparedSQL());
		return rs;
	}
	/**
	 * select文を実行
	 * @param tableName
	 * @param properties
	 * @param where
	 * @return
	 * @throws InstantiationException
	 * @throws IllegalAccessException
	 * @throws ClassNotFoundException
	 * @throws SQLException
	 */
	public ArrayList<HashMap<String, String>> select(String tableName, HashMap<String, String> properties,  AbstractCondition where) throws InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException{
		Connection conn = getConnection();
		PreparedStatement st;
		ResultSet rs = null;
		ArrayList<HashMap<String, String>> result = new ArrayList<HashMap<String, String>>();
			
		if(where != null){//condisionからsql文を作成
			Log.finer("SELECT * FROM " + tableName + " WHERE " + where.toPreparedSQL());
			st = conn.prepareStatement("SELECT * FROM " + tableName + " WHERE " + where.toPreparedSQL());
			where.setPreparedSQL(st);
		}
		else
			st = conn.prepareStatement("SELECT * FROM " + tableName);
			
			rs = st.executeQuery();
						
			if(rs != null){
				while (rs.next()) {
					HashMap<String, String> data = new HashMap<String, String>();
					data.put("id", rs.getString("id"));
					Iterator<Entry<String, String>> ite = properties.entrySet().iterator();
					while(ite.hasNext()){
						Entry<String, String> en = ite.next();
						data.put(en.getKey(), rs.getString(en.getKey()));
					}
					result.add(data);
				}
				rs.close();
			}
			
			st.close();
			conn.commit();
			close();
			
			return result;
		}
		
		public void close() throws SQLException{
			if(this.conn == null)
				return;
			this.conn.close();
			this.conn = null;
		}
				
}

