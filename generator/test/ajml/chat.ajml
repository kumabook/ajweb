<?xml version="1.0" encoding="UTF-8"?>
<ajml  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="./resources/schema/ajml.xsd" >
  <application name="chat" root="chat_room">

    
    <!-- データモデル -->
    <databases>
    <!-- チャットルームの一覧を保持するテーブル -->
      <database id="room">
  	<property name="name" type="string"/>
	<property name="message" type="ref" multiplicity="*" ref="message"/>
	<init>
	  <item><property name="name" value="ルーム１"/></item>
	  <item><property name="name" value="ルーム２"/></item>
	  <item><property name="name" value="ルーム３"/></item>
	  <item><property name="name" value="ルーム４"/></item>
	  <item><property name="name" value="ルーム５"/></item>
	</init>
      </database>
      <!-- チャットのメッセージを保持するテーブル -->
      <database id="message">
	<property name="room" type="ref" multiplicity="1" ref="room"/>
      	<property name="message" type="string"/>
      	<property name="user_name" type="string"/>
      	<property name="posted" type="datetime"/>
      </database>
    </databases>


    <!-- UIモデル -->
    <interfaces>
      <frame id="root">
	<!-- 画面 -->
 	<panel id="entrance_room">
	  <label id="roomSelectLabel" content="ルーム選択" left="0px" top="0px"/>
    	  <selectbox id="roomSelect"  top="100px" left="100px"/>
    	  <button id="enterButton"  content="enter"  top="300px" left="100px"/>
  	</panel>

	<!-- チャットルーム画面-->
  	<panel id="chat_room" width="100%" height="100%">
    	  <label id="user_name_label" content="名前" top="10px" left="20px"/>
	  <textbox id="user_name" content="user_name" top="10px" left="100px"/>
    	  <label id="message_label" content="メッセージ" top="30px" left="20px"/>
    	  <textbox id="message" content="message" top="30px" left="100px"/>
    	  <button id="submit"  content="submit"  top="50px" left="100px"/>
      	  <table id="message_list" top="100px" left="100px" width="400px" height="500px">
      	    <th field="user_name" name="名前"/>
	    <th field="message" name="メッセージ"/>
      	    <th field="posted" name="投稿日時"/>
      	  </table>
	</panel>
      </frame>
    </interfaces>

    <!--イベントモデル -->
    <events>
      <!-- 初期画面の設定-->
      <event target="root" type="display">
	<action>
	  <call element="root" func="selectPanel">
	    <param name="panel">
	      <string>entrance_room</string>
	    </param>
	  </call>
	</action>
      </event>
      <!-- 入室画面の初期化-->
      <event target="entrance_room" type="display">
	<action>
	  <!-- チャットルームの一覧の取得-->
	  <call element="roomSelect" func="load">
	    <param name="datum">
	      <select database="room"/>
	    </param>
	  </call>
	</action>
      </event>
      <!-- チャットルーム画面の初期化-->
      <event target="chat_room" type="display">
	<action>
	  <!-- メッセージリストの取得-->
	  <call element="message_list" func="load">
	    <param name="datum">
	      <selectByCondition database="chatDB">
		<condition>
		  <eq>
		    <targetItem property="room_id"/>
		    <get element="roomSelect" property="value">
		      <param name="property">
			<string>id</string>
		      </param>
		    </get>
		  </eq>
		</condition>
	      </selectByCondition>
<!--	      <selectRefItem database="room" ref="message">
		<get element="roomSelect" property="value"/>
	      </selectRefItem>-->
<!---
	      <selectByCondition database="message">
		<eq>
		  <targetItem property="room_id"/>
		  <get element="roomSelect" property="value">
		    <param name="property">
		      <string>id</string>
		    </param>
		  </get>
		</eq>
	      </selectByCondition>
-->
	    </param>
	  </call>
	</action>
      </event>
      <!-- 入室処理-->
      <event target="enterButton" type="Click">
	<action>
	  <insert database="message">
	    <param name="message">
	      <concat>
		<param name="left">
		  <get element="user" property="value"/>
		</param>
		<param name="right">
		  <string>が入室しました。</string>
		</param>
	      </concat>
	    </param>
	    <param name="user_name">
	      <get element="user_name_en" property="content"/>
	    </param>
	    <param name="enter_time"> 
	      <datetime value="0" />
	    </param>
	  </insert>
	</action>
      </event> 

      <!-- メッセージの送信-->
      <event target="submit" type="click">
	<action>
	  <insert id="insert_message" database="message">
	    <param name="message">
	      <get element="message" property="value"/>
	    </param>
	    <param name="user_name"> 
	      <get element="user_name" property="value"/>
	    </param>
	    <param name="room">
	      <get element="room_select" property="value"/>
	    </param>
	    <param name="posted">
	      <datetime value="0"/>
	    </param>
	  </insert>
	  <branch>
	    <condition>
	      <success func_id = "insert_message">
	      </success>
	    </condition>
	    <then>
	    </then>
	    <else>
	    </else>
	  </branch>
	</action>
      </event>
      <!-- メッセージの変更を反映-->
      <event target="message" type="insert">
	<condition>
	  <eq>
	    <receivedItem property="room_id"/>
	    <get element="selectbox" property="selectedValue"/>
	  </eq>
	</condition>
	<action>
	  <call element="messageTable" func="insert">
	    <param name="user_name">
	      <targetItem property="userName"/>
	    </param>
	    <param name="message">
	      <targetItem property="message"/>
	    </param>
	    <param name="posted">
	      <targetItem property="posted"/>
	    </param>
	  </call>
	</action>
      </event>
    </events>
  </application>
</ajml>

